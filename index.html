<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Selector aleatorio de dedos</title>
  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Fuente retro gamer -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;
      --panel:#0b1220ee; /* barra superior */
      --text:#e5e7eb;
      --dim:#334155; /* jugadores atenuados */
      --winner:#ef4444; /* rojo ganador */
      --accent:#38bdf8;
      --titleGlow:#f472b6; /* rosa 80s */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    #app{position:fixed;inset:0;touch-action:none;}
    canvas{position:absolute;inset:0;display:block;}

    /* ======= T√≠tulo retro arriba del todo ======= */
    .titlebar{position:absolute;left:0;right:0;top:0;height:44px;display:flex;align-items:center;justify-content:center;z-index:11}
    .titlebar .title{
      font-family:'Press Start 2P', system-ui, monospace;
      font-size:14px; letter-spacing:1px;
      text-transform:uppercase;
      color:#fff;
      text-shadow:0 0 6px var(--titleGlow), 0 0 14px #9f7aea;
    }

    /* ======= HUD como barra superior justo debajo del t√≠tulo ======= */
    .hud{position:absolute;left:0;right:0;top:44px;background:var(--panel);
      border-bottom:1px solid #ffffff22;padding:8px 12px;backdrop-filter:blur(6px);
      display:flex;align-items:center;gap:10px;justify-content:space-between;z-index:10;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:10px;border:1px solid #ffffff22;background:#ffffff10;display:flex;align-items:center;gap:8px}
    .timer{display:flex;align-items:center;gap:6px}
    .timer button{min-width:36px;min-height:32px}

    .controls{position:absolute;left:50%;bottom:16px;transform:translateX(-50%);display:flex;gap:10px;z-index:5}
    button{appearance:none;border:none;background:var(--accent);color:#0b1220;font-weight:700;padding:8px 12px;border-radius:12px;box-shadow:0 6px 16px #0008;cursor:pointer}
    button.secondary{background:#111827;color:#e5e7eb;border:1px solid #ffffff22}
    button.ghost{background:transparent;color:#e5e7eb;border:1px solid #ffffff22}
    button:disabled{opacity:.55}

    .toast{position:absolute;right:12px;bottom:16px;background:var(--panel);border:1px solid #ffffff22;border-radius:10px;padding:8px 12px;max-width:70vw;z-index:15}
  </style>
</head>
<body>
  <div id="app">
    <canvas id="scene"></canvas>

    <!-- T√≠tulo retro fuera del HUD, arriba del todo -->
    <div class="titlebar"><div class="title">Selector aleatorio de dedos</div></div>

    <!-- HUD superior (solo estado, instalar, vibraci√≥n/sonido y contador) -->
    <div class="hud">
      <div class="brand">
        <div class="pill" id="status">Esperando toques‚Ä¶</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="btnInstall" class="ghost" style="display:none">Instalar</button>
        <div class="pill" id="avControls">
          <button id="btnSound" title="Sonido">üîä</button>
          <button id="btnVibrate" title="Vibraci√≥n">üì≥</button>
        </div>
        <div class="pill timer" id="timer">
          ‚è±Ô∏è <span id="timeVal">5.0s</span>
          <button id="btnMinus" title="-1s">‚àí</button>
          <button id="btnPlus" title="+1s">+</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="btnStart" class="secondary">Forzar inicio</button>
      <button id="btnReset">Reiniciar</button>
    </div>

    <div class="toast" id="toast" style="display:none"></div>
  </div>

  <script>
  (function(){
    // ===== Service Worker (sube el n√∫mero para forzar actualizaci√≥n de cach√©) =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js?v=8')
        .then(()=>console.log('SW registrado'))
        .catch(err=>console.error('SW error', err));
    }

    const canvas = document.getElementById('scene');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const timerText = document.getElementById('timeVal');
    const toastEl = document.getElementById('toast');
    const btnStart = document.getElementById('btnStart');
    const btnReset = document.getElementById('btnReset');
    const btnMinus = document.getElementById('btnMinus');
    const btnPlus = document.getElementById('btnPlus');
    const btnInstall = document.getElementById('btnInstall');
    const btnSound = document.getElementById('btnSound');
    const btnVibrate = document.getElementById('btnVibrate');

    const S_WAITING = 'waiting';
    const S_CHOOSING = 'choosing';
    const S_FINISHED = 'finished';

    let state = S_WAITING;
    let touches = new Map(); // id -> {x,y,color,number}
    let idToNumber = new Map();
    let usedNumbers = new Set(); // n√∫meros actualmente asignados

    let countdownDuration = 5.0;
    let countdown = countdownDuration;
    let countdownActive = false;
    let countdownHandle = null;

    const chooseDurationMs = 5000; // ~5s ruleta
    const chooseStepMs = 120;
    let chooseHandle = null;
    let chooseTimeout = null;
    let lockedIds = [];
    let highlightIndex = -1;

    let winnerId = null;

    let particles = [];

    // ===== Sonido y vibraci√≥n (solo toggles) =====
    let soundEnabled = true;
    let vibrationEnabled = true;
    let deferredPrompt = null;
    let audioCtx = null, masterGain = null;

    function ensureAudio(){
      if (!soundEnabled) return;
      if (!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.6; // volumen fijo
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === 'suspended'){ audioCtx.resume(); }
    }
    function playTone(freq=700, ms=80, volMul=1){
      if (!soundEnabled) return;
      ensureAudio();
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      g.gain.value = 0.6 * volMul;
      osc.connect(g); g.connect(masterGain);
      const now = audioCtx.currentTime;
      osc.start(now);
      osc.stop(now + ms/1000);
    }
    function playTick(){ playTone(800, 60, 0.35); }
    function playWin(){ playTone(520, 160, 0.9); setTimeout(()=> playTone(880, 220, 1.0), 160); }

    function vibe(ms=15){
      if (!vibrationEnabled || !('vibrate' in navigator)) return;
      try{ navigator.vibrate(ms); }catch(e){}
    }
    function vibeWin(){
      if (!vibrationEnabled || !('vibrate' in navigator)) return;
      try{ navigator.vibrate([80,40,120]); }catch(e){}
    }

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(innerWidth * dpr);
      canvas.height = Math.floor(innerHeight * dpr);
      canvas.style.width = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resize);
    resize();

    function showToast(msg){
      toastEl.textContent = msg; toastEl.style.display='block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.style.display='none', 2200);
    }

    function updateStatus(){
      const total = touches.size;
      const map = {
        [S_WAITING]: `Esperando toques‚Ä¶ (${total})`,
        [S_CHOOSING]: `Eligiendo‚Ä¶`,
        [S_FINISHED]: winnerId!=null? `Ganador: #${idToNumber.get(winnerId)}` : `Finalizado`,
      };
      statusEl.textContent = map[state];
    }

    // -------- Countdown ---------
    function startCountdown(){
      if (countdownActive) return;
      countdownActive = true;
      countdown = countdownDuration;
      timerText.textContent = `${countdown.toFixed(1)}s`;
      countdownHandle = setInterval(()=>{
        countdown = Math.max(0, countdown - 0.1);
        timerText.textContent = `${countdown.toFixed(1)}s`;
        if (countdown <= 0){
          clearInterval(countdownHandle); countdownActive = false;
          startChoosingEffect();
        }
      }, 100);
    }

    // -------- Choosing effect ---------
    function startChoosingEffect(){
      lockedIds = Array.from(touches.keys());
      if (lockedIds.length === 0){ showToast('No hay jugadores'); resetAll(); return; }
      state = S_CHOOSING; updateStatus();
      highlightIndex = -1;
      chooseHandle = setInterval(()=>{
        if (lockedIds.length === 0) return;
        highlightIndex = (highlightIndex + 1) % lockedIds.length;
        playTick();
        vibe(15); // vibraci√≥n corta por cada resaltado
      }, chooseStepMs);
      chooseTimeout = setTimeout(()=>{ finishAndPickWinner(); }, chooseDurationMs);
    }

    function finishAndPickWinner(){
      clearInterval(chooseHandle); chooseHandle=null;
      clearTimeout(chooseTimeout); chooseTimeout=null;
      const idx = Math.floor(Math.random()*lockedIds.length);
      winnerId = lockedIds[idx];
      state = S_FINISHED; updateStatus();
      vibeWin();
      playWin();
      const w = touches.get(winnerId); if (w){ spawnConfetti(w.x, w.y); }
      showToast(`¬°Ganador: #${idToNumber.get(winnerId)}! üéâ`);
    }

    // -------- Reset ---------
    function resetAll(){
      clearInterval(countdownHandle); countdownHandle=null; countdownActive=false;
      clearInterval(chooseHandle); chooseHandle=null; clearTimeout(chooseTimeout); chooseTimeout=null;
      touches.clear(); idToNumber.clear(); usedNumbers.clear(); lockedIds=[]; highlightIndex=-1; winnerId=null; particles=[];
      state = S_WAITING; updateStatus();
      timerText.textContent = `${countdownDuration.toFixed(1)}s`;
    }

    // -------- Drawing ---------
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const g = ctx.createRadialGradient(innerWidth*0.5, innerHeight*0.4, 50, innerWidth*0.5, innerHeight*0.6, Math.max(innerWidth,innerHeight));
      g.addColorStop(0,'#0b1220'); g.addColorStop(1,'#0a0f1d');
      ctx.fillStyle = g; ctx.fillRect(0,0,innerWidth,innerHeight);

      const now = performance.now();
      for (const [id, t] of touches){
        if (state!==S_WAITING && !lockedIds.includes(id)) continue;
        const r = 36;
        // Sombra
        ctx.globalAlpha = 0.5; ctx.beginPath(); ctx.arc(t.x, t.y+4, r, 0, Math.PI*2); ctx.fillStyle = '#0008'; ctx.fill(); ctx.globalAlpha = 1;
        // C√≠rculo
        ctx.beginPath(); ctx.arc(t.x, t.y, r, 0, Math.PI*2);
        let fill;
        if (state===S_WAITING){ fill = t.color; }
        else if (state===S_CHOOSING){ const highlightId = lockedIds[highlightIndex]; fill = (id===highlightId) ? t.color : getCssVar('--dim'); }
        else { fill = (id===winnerId) ? getCssVar('--winner') : getCssVar('--dim'); }
        ctx.fillStyle = fill; ctx.fill();
        ctx.lineWidth = 3; ctx.strokeStyle = '#ffffff55'; ctx.stroke();
        // N√∫mero centrado
        const num = idToNumber.get(id) || '?';
        ctx.fillStyle = '#fff'; ctx.font = '700 22px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(num, t.x, t.y);

        // Halo/pulso al resaltado
        if (state===S_CHOOSING && id===lockedIds[highlightIndex]){
          const pulse = (Math.sin(now/200)+1)/2; // 0..1
          ctx.save();
          ctx.beginPath(); ctx.arc(t.x, t.y, r + 6 + 8*pulse, 0, Math.PI*2);
          ctx.lineWidth = 4 + 2*pulse; ctx.globalAlpha = 0.35 + 0.25*pulse;
          ctx.shadowBlur = 20 + 20*pulse; ctx.shadowColor = t.color;
          ctx.strokeStyle = t.color; ctx.stroke();
          ctx.restore(); ctx.globalAlpha = 1; ctx.shadowBlur = 0;
        }
      }

      stepParticles();
      requestAnimationFrame(draw);
    }

    function getCssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

    // --- Confeti lento ---
    function spawnConfetti(x, y){
      const count = 160;
      for (let i=0;i<count;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*3;
        particles.push({ x, y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed - 2, life: 140 + Math.random()*100, size: 3 + Math.random()*4, rot: Math.random()*Math.PI, vr: (Math.random()-0.5)*0.2, color: `hsl(${Math.floor(Math.random()*360)},80%,60%)` });
      }
    }
    function stepParticles(){
      for (let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.vy += 0.05; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life -= 1;
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillStyle = p.color; ctx.fillRect(-p.size*0.5, -p.size*0.5, p.size, p.size); ctx.restore();
        if (p.life<=0 || p.y>innerHeight+20) particles.splice(i,1);
      }
    }

    // -------- Touch handling ---------
    const app = document.getElementById('app');
    function randomColor(){ const hue = Math.floor(Math.random()*360); return `hsl(${hue},70%,50%)`; }

    function onTouchStart(ev){
      if (ev.target.closest('.titlebar, .hud, .controls, button, select, input')) return; // ignora toques en UI
      ev.preventDefault(); ensureAudio();
      const nowFirst = !countdownActive && state===S_WAITING && ev.touches.length>=1 && touches.size===0;
      if (nowFirst) startCountdown();
      for (const t of ev.changedTouches){
        if (state!==S_WAITING) continue;
        if (!idToNumber.has(t.identifier)) {
          const num = allocateNumber();
          idToNumber.set(t.identifier, num);
        }
        touches.set(t.identifier, {x:t.clientX, y:t.clientY, color:randomColor()});
      }
      updateStatus();
    }
    function onTouchMove(ev){
      if (ev.target.closest('.titlebar, .hud, .controls, button, select, input')) return;
      ev.preventDefault(); if (state!==S_WAITING) return;
      for (const t of ev.changedTouches){ const obj = touches.get(t.identifier); if (obj){ obj.x = t.clientX; obj.y = t.clientY; } }
    }
    function onTouchEnd(ev){
      if (ev.target.closest('.titlebar, .hud, .controls, button, select, input')) return;
      ev.preventDefault();
      for (const t of ev.changedTouches){
        if (state===S_WAITING){
          const num = idToNumber.get(t.identifier);
          if (num){ usedNumbers.delete(num); }
          touches.delete(t.identifier); idToNumber.delete(t.identifier);
        }
      }
      updateStatus();
    }

    app.addEventListener('touchstart', onTouchStart, {passive:false});
    app.addEventListener('touchmove', onTouchMove, {passive:false});
    app.addEventListener('touchend', onTouchEnd, {passive:false});
    app.addEventListener('touchcancel', onTouchEnd, {passive:false});

    // -------- Botones (Pointer + autorepetici√≥n) ---------
    function adjTime(delta){
      countdownDuration = Math.max(1, Math.min(60, countdownDuration + delta));
      if (!countdownActive) timerText.textContent = `${countdownDuration.toFixed(1)}s`;
    }
    function bindHold(btn, delta){
      let holdT=null, repI=null;
      btn.addEventListener('pointerdown', (e)=>{
        e.preventDefault(); e.stopPropagation();
        adjTime(delta);
        holdT = setTimeout(()=>{ repI = setInterval(()=> adjTime(delta), 80); }, 350);
      });
      const clear=()=>{ if(holdT){clearTimeout(holdT);holdT=null;} if(repI){clearInterval(repI);repI=null;} };
      ['pointerup','pointercancel','pointerleave'].forEach(evt=> btn.addEventListener(evt, clear));
      window.addEventListener('pointerup', clear);
    }
    bindHold(btnMinus, -1);
    bindHold(btnPlus, +1);

    btnStart.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); if (state===S_WAITING){ startCountdown(); } });
    btnReset.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); resetAll(); });

    // -------- Instalaci√≥n (beforeinstallprompt) ---------
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      if (!isStandalone) btnInstall.style.display = 'inline-flex';
    });

    btnInstall.addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      if (!deferredPrompt) { showToast('Si no aparece el cuadro, usa ‚ãÆ ‚Üí A√±adir a pantalla principal'); return; }
      deferredPrompt.prompt();
      const res = await deferredPrompt.userChoice;
      deferredPrompt = null; btnInstall.style.display = 'none';
      if (res && res.outcome === 'accepted'){ showToast('Instalaci√≥n iniciada ‚úÖ'); }
    });

    window.addEventListener('appinstalled', ()=>{ showToast('App instalada ‚úÖ'); btnInstall.style.display = 'none'; });

    updateStatus();
    timerText.textContent = `${countdownDuration.toFixed(1)}s`;
    draw();

    // ==== Gesti√≥n de n√∫meros ====
    function allocateNumber(){
      let n = 1;
      while (usedNumbers.has(n)) n++;
      usedNumbers.add(n);
      return n;
    }
  })();
  </script>
</body>
</html>
